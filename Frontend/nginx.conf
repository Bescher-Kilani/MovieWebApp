# =============================================================================
# NGINX CONFIGURATION FOR REACT SPA (Single Page Application)
# =============================================================================
# This config serves a React app built with Vite/Create React App
# Key features:
# - React Router support (all routes fallback to index.html)
# - Gzip compression for faster load times
# - Security headers to prevent XSS, clickjacking
# - Aggressive caching for static assets
# - No caching for HTML (to ensure users get latest version)
# =============================================================================

server {
    # ==========================================================================
    # SERVER BASICS
    # ==========================================================================
    
    # Listen on port 80 (HTTP)
    # Railway handles HTTPS/SSL termination externally, so we only need HTTP here
    listen 80;
    
    # Accept ALL domains/subdomains (wildcard)
    # Important for Railway since URL changes with each deploy
    # Also works with custom domains later
    server_name _;
    
    # Root directory where React build files are located
    # This is where "COPY --from=build /app/dist /usr/share/nginx/html" puts files
    root /usr/share/nginx/html;
    
    # Default file to serve when accessing root URL (/)
    index index.html;

    # ==========================================================================
    # GZIP COMPRESSION (Reduces file sizes by ~70%)
    # ==========================================================================
    
    # Enable gzip compression
    gzip on;
    
    # Add "Vary: Accept-Encoding" header (tells proxies to cache gzipped and non-gzipped separately)
    gzip_vary on;
    
    # Enable compression for proxied requests (CDNs, load balancers)
    gzip_proxied any;
    
    # Compression level (1-9, where 6 is optimal balance of speed/size)
    # Higher = better compression but slower
    gzip_comp_level 6;
    
    # Minimum file size to compress (bytes)
    # Files smaller than this won't be compressed (not worth the CPU)
    gzip_min_length 1000;
    
    # File types to compress
    # NOTE: Images (jpg, png) are already compressed, so we skip them
    gzip_types
        text/plain              # .txt files
        text/css                # .css files
        application/json        # .json files
        application/javascript  # .js files (modern)
        text/xml                # .xml files
        application/xml         # .xml files (alt)
        application/xml+rss     # RSS feeds
        text/javascript         # .js files (legacy)
        image/svg+xml;          # .svg files (SVG is text-based, compresses well)

    # ==========================================================================
    # SECURITY HEADERS (Protect against common attacks)
    # ==========================================================================
    
    # Clickjacking Protection: Prevent site from being loaded in <iframe> on OTHER domains
    # "SAMEORIGIN" = Allow iframes only from same domain
    # Blocks attacks where hackers overlay your site in invisible iframe to steal clicks
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # MIME-Type Sniffing Protection: Force browser to respect Content-Type header
    # Prevents browser from "guessing" file type and executing malicious scripts
    # Example: Uploaded "image.jpg" that's actually JavaScript won't execute
    add_header X-Content-Type-Options "nosniff" always;
    
    # XSS Protection (Legacy but doesn't hurt): Block page if XSS attack detected
    # Modern browsers use Content-Security-Policy instead, but this helps older browsers
    # "mode=block" = Block entire page instead of trying to sanitize
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer Policy: Control how much referrer info is sent with requests
    # "no-referrer-when-downgrade" = Send full URL except when HTTPS→HTTP
    # Balances privacy and analytics
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # Content-Security-Policy (Optional but recommended)
    # Uncomment to enable strict CSP (blocks inline scripts, only allows same-origin)
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';" always;

    # ==========================================================================
    # REACT ROUTER SUPPORT (SPA - Single Page Application)
    # ==========================================================================
    # This is THE MOST IMPORTANT part for React Router!
    # Without this, refreshing /movie/123 gives 404 error
    
    location / {
        # try_files directive attempts to serve files in this order:
        # 1. $uri          - Try exact file (e.g., /hero.png → serves /hero.png)
        # 2. $uri/         - Try as directory (e.g., /assets/ → serves /assets/index.html)
        # 3. /index.html   - Fallback to index.html (for React Router routes)
        #
        # Example flow:
        # User visits /movie/123:
        #   1. Try file: /usr/share/nginx/html/movie/123 (doesn't exist)
        #   2. Try dir:  /usr/share/nginx/html/movie/123/ (doesn't exist)
        #   3. Fallback: /usr/share/nginx/html/index.html (exists! ✓)
        #   4. React app loads, sees URL /movie/123, renders MovieDetail component
        try_files $uri $uri/ /index.html;
    }

    # ==========================================================================
    # CACHING - STATIC ASSETS (1 year cache)
    # ==========================================================================
    # Cache images, fonts, etc. for 1 year
    # Safe because Vite generates unique hashes (index-abc123.js)
    # When code changes, hash changes → new filename → browser fetches new file
    
    # Image files (already compressed, so no gzip)
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
        # Cache for 1 year
        expires 1y;
        
        # Cache-Control header
        # "public" = Can be cached by CDNs/proxies
        # "immutable" = File will NEVER change (with this filename)
        add_header Cache-Control "public, immutable";
        
        # Disable access logs for static files (reduces log size)
        access_log off;
    }

    # CSS and JavaScript files (Vite generates with hash: index-abc123.js)
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Web fonts (also versioned/hashed)
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ==========================================================================
    # NO CACHE - HTML FILES
    # ==========================================================================
    # index.html must NEVER be cached!
    # It contains references to versioned JS/CSS files (index-abc123.js)
    # If we cache index.html, users won't get new JS/CSS after deployments
    
    location = /index.html {
        # No caching at all
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # Legacy header for HTTP/1.0 proxies
        add_header Pragma "no-cache";
        
        # Expire immediately
        add_header Expires 0;
    }

    # Also don't cache any other HTML files (if you have multiple pages)
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ==========================================================================
    # ERROR PAGES (Optional)
    # ==========================================================================
    # Custom error pages (uncomment if you create custom error pages)
    # error_page 404 /404.html;
    # error_page 500 502 503 504 /50x.html;

    # ==========================================================================
    # SECURITY - HIDE NGINX VERSION
    # ==========================================================================
    # Hide nginx version in error pages and headers
    # Prevents attackers from knowing exact version for targeted exploits
    server_tokens off;

    # ==========================================================================
    # PERFORMANCE - CLIENT BODY SIZE
    # ==========================================================================
    # Maximum upload size (default 1MB)
    # Increase if your app allows file uploads
    # client_max_body_size 10M;
}

# =============================================================================
# END OF NGINX CONFIGURATION
# =============================================================================